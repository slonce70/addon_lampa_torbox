# Аналіз проекту: TorBox Lampa Plugin (Stable)

## 1. Загальний огляд

Цей проект є плагіном для медіа-центру Lampa, який інтегрується з хмарним торрент-клієнтом TorBox. Плагін дозволяє користувачам шукати торренти на публічних трекерах, додавати їх до свого облікового запису TorBox, чекати на завантаження та відтворювати відеофайли безпосередньо в інтерфейсі Lampa.

Код написаний на чистому JavaScript (ES6+), має чітку модульну архітектуру і слідує сучасним практикам розробки, таким як використання IIFE для ізоляції області видимості, `'use strict';` для підвищення надійності та впровадження власних рішень для кешування, конфігурації та взаємодії з API.

## 2. Архітектура та ключові модулі

Плагін структурований як набір логічно розділених модулів, кожен з яких відповідає за свою частину функціональності.

### `Utils`
Набір допоміжних "чистих" функцій, які не залежать від стану програми.
- **Форматування даних:** `formatBytes`, `formatTime`, `formatAge` для представлення даних у людино-читаному вигляді.
- **Обробка рядків:** `escapeHtml` для захисту від XSS-атак, `getQualityLabel` для визначення якості відео за назвою.
- **Сортування:** `naturalSort` для коректного сортування файлів з номерами (напр., "серія 1", "серія 10", "серія 2").

### `Storage` (`safeStorage` + `Store`)
Відповідає за збереження налаштувань та стану.
- **`safeStorage`:** Розумна обгортка, яка намагається використовувати `localStorage`. Якщо `localStorage` недоступний (напр., в режимі інкогніто), вона автоматично переключається на тимчасове сховище в пам'яті (in-memory object). Це робить плагін стійким до збоїв у різних середовищах.
- **`Store`:** Простий інтерфейс (`get`, `set`) для роботи з `safeStorage`.

### `Cache`
Реалізація простого LRU-кешу (Least Recently Used) в пам'яті.
- **Призначення:** Зберігає результати пошуку для конкретного фільму на 10 хвилин (`TTL_MS`).
- **Переваги:** Значно прискорює повторне відкриття сторінки з торрентами, зменшуючи кількість запитів до API і роблячи інтерфейс більш відзивчивим.
- **Реалізація:** Використовує `Map` для ефективного доступу та видалення елементів. Має обмеження за розміром (`LIMIT`), щоб не займати багато пам'яті.

### `Config`
Централізоване управління конфігурацією.
- **`DEF`:** Зберігає налаштування за замовчуванням.
- **`CFG`:** Надає гетери та сетери для доступу до налаштувань, які зберігаються через `Store`.
- **API Key:** Ключ API зберігається в `localStorage` у форматі Base64. Це не є надійним шифруванням, а скоріше простою обфускацією, щоб ключ не зберігався у відкритому вигляді.
- **`LOG`:** Функція для логування, яка активна лише при ввімкненому режимі відладки (`debug`).

### `Api`
Модуль для взаємодії з зовнішніми сервісами. Це ядро мережевої логіки.
- **`request`:** Універсальна функція для виконання HTTP-запитів. Вона автоматично:
    - Використоє CORS-проксі, вказаний у налаштуваннях.
    - Встановлює таймаут запиту (20 секунд) для уникнення "зависань".
    - Додає API-ключ TorBox до заголовків.
- **`_process`:** Централізований обробник відповідей. Аналізує HTTP-статуси (401, 403, 429 і т.д.) і перетворює їх у зрозумілі помилки.
- **`searchPublicTrackers`:** Послідовно опитує публічні парсери (Viewbox, Jacred) у пошуках торрентів. Якщо один парсер не відповідає, переходить до наступного.
- **`checkCached`:** Відправляє хеші знайдених торрентів до TorBox, щоб визначити, які з них вже закешовані на сервері (позначаються іконкою `⚡`).
- **Інші методи:** `addMagnet`, `myList`, `requestDl` — прямі виклики відповідних ендпоінтів TorBox API.

### `ErrorHandler`
Простий модуль для відображення помилок користувачеві через систему сповіщень Lampa (`Lampa.Noty.show`).

## 3. Компоненти UI

### `MainComponent`
Це основний "контролер" плагіна, який керує всім життєвим циклом екрану з результатами пошуку.

#### Ключова логіка (User Flow)
1.  **Пошук (`search`):**
    - За замовчуванням пошук виконується за назвою фільму.
    - **Реалізовано повноцінний рядок пошуку**, що дозволяє вводити довільні запити.
    - **"Уточнити пошук":** Додано функцію, яка генерує комбінації з оригінальної та локалізованої назви і року випуску, дозволяючи користувачеві швидко спробувати альтернативні варіанти пошуку.
    - При запуску спочатку перевіряється кеш. Якщо дані є, вони миттєво відображаються.
    - Якщо кешу немає, запускається ланцюжок асинхронних запитів: `searchPublicTrackers` -> `checkCached`.
    - Результати обробляються, форматуються (`procRaw`) і зберігаються в кеш.
2.  **Взаємодія з користувачем (`onTorrentClick`):**
    - Користувач обирає торрент.
    - **Інтеграція з історією:** Фільм негайно додається до вбудованої історії переглядів Lampa.
    - **Візуальна відмітка:** На обраному торренті миттєво з'являється іконка "відтворення" (▶), вказуючи, який торрент був запущений останнім.
    - Плагін відправляє запит на додавання магнет-посилання в TorBox (`addMagnet`).
    - З'являється екран завантаження.
3.  **Відстеження прогресу (`track`):**
    - Це ключова функція для UX. Вона періодично (кожні 10 секунд) опитує API TorBox (`myList`), щоб отримати статус завантаження торрента.
    - На екрані завантаження відображається актуальний прогрес, швидкість, кількість сідерів/пірів та час до завершення.
4.  **Вибір файлу та відтворення (`selectFile`):**
    - Коли TorBox повідомляє про завершення завантаження, `track` повертає дані про файли.
    - Якщо у торренті один відеофайл, він одразу відтворюється.
    - Якщо файлів декілька (напр., серіал), **запускається екран вибору епізодів** для вибору серії.

#### Управління станом та UI
- **Стан:** Компонент має власний об'єкт `state` для зберігання списку торрентів, активного сортування та фільтрів. Налаштування зберігаються в `localStorage` і відновлюються при наступному запуску.
- **Фільтр кешованих торрентів:** Додано кнопку-перемикач (`⚡`/`☁️`), що дозволяє миттєво відфільтрувати список і показати тільки ті торренти, які вже доступні в хмарі TorBox.
- **"Продовжити перегляд":** На екрані з'являється спеціальний блок, який дозволяє швидко повернутися до останнього переглянутого торрента для даного фільму/серіалу.
- **"Tech Bar":** Для кожного торрента генерується інформаційна панель з технічними даними: розширення, відео/аудіо кодеки, мови доріжок, наявність HDR/Dolby Vision. Це значно спрощує вибір.
- **Фільтри:** Генеруються динамічно на основі даних, отриманих з трекерів (напр., якщо немає 4K-торрентів, такий фільтр не буде показаний).

### `EpisodeListComponent` (Екран вибору епізодів)
Спеціалізований компонент для відображення списку файлів (серій) всередині одного торрента.
- **Призначення:** Замінює стандартне діалогове вікно, надаючи більш зручний та інформативний інтерфейс для серіалів.
- **Функціональність:**
    - Сортує файли за допомогою `Utils.naturalSort`.
    - Зберігає та **відображає останню відтворену серію**, що дозволяє легко продовжити перегляд.
    - **Миттєва відмітка про перегляд:** При кліку на епізод він одразу візуально позначається як переглянутий (стає сірим), не чекаючи повернення на екран.
    - При виборі файлу викликає `Api.requestDl` та передає посилання плеєру Lampa.

## 4. Інтеграція з Lampa

Плагін грамотно інтегрується в екосистему Lampa, використовуючи стандартні API.
- **Ініціалізація (`boot`):** Код очікує на повне завантаження Lampa (`Lampa.Listener.follow('app', ...)`), перш ніж реєструвати свої компоненти.
- **Реєстрація:** Реєструє компонент `torbox_main`, шаблони, переклади та налаштування через відповідні API.
- **Додавання кнопки:** Кнопка "Смотреть через TorBox" додається на сторінку фільму за допомогою слухача подій `Lampa.Listener.follow('full', ...)`.
- **Стилі:** Всі необхідні CSS-стилі інкапсульовані та додаються в `<head>` документу динамічно, що запобігає конфліктам з іншими плагінами.

## 5. Висновки

### Сильні сторони
- **Надійність:** Код має відмінну обробку помилок, використовує `try...catch` для мережевих запитів, має запасний механізм для `localStorage` та таймаути для запитів.
- **Продуктивність:** Використання LRU-кешу значно покращує досвід користувача при повторних діях.
- **Структура:** Чітка модульна архітектура робить код легким для читання, підтримки та розширення.
- **UX (User Experience):**
    - **Потужний пошук:** Можливість точного налаштування пошуку через комбінації значно підвищує шанси знайти потрібний контент.
    - **Інтеграція з історією Lampa:** Забезпечує безшовний досвід для користувача.
    - **Миттєвий фідбек:** Іконка останнього відтворення (▶) та миттєва відмітка переглянутих серій роблять інтерфейс інтуїтивним.
    - **Зручний вибір серій:** Спеціалізований екран є значним покращенням у порівнянні зі стандартним діалогом.
    - **"Продовжити перегляд":** Функція економить час користувача.
    - **Інформативність:** Детальна технічна інформація (`Tech Bar`) допомагає зробити правильний вибір.
    - **Відстеження завантаження:** Відображення прогресу є дуже зручним.
- **Автономність:** Плагін є повністю самодостатнім і не має зовнішніх залежностей (крім Lampa API).

### Можливі покращення
- **Механізм оновлення статусу:** Замість постійного опитування (`polling`) в функції `track`, можна було б використовувати WebSockets або Server-Sent Events, якби API TorBox їх підтримував. Це було б більш ефективним з точки зору мережевих ресурсів.
- **Конфігурація:** Деякі "магічні числа" (напр., таймаут опитування `10000` мс, ліміт кешу `128`) можна було б винести в модуль `Config` для легшої зміни.
- **Безпека API-ключа:** Хоча обфускація через Base64 є поширеною практикою для клієнтських додатків, вона не забезпечує реальної безпеки. Однак, в контексті плагіна для Lampa, це є прийнятним компромісом.

**Загалом, це високоякісний, стабільний та продуманий плагін, який демонструє глибоке розуміння як JavaScript, так і архітектури Lampa.**