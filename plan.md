# План аудита и стабилизации TorBox Lampa Plugin (MVP)

Дата: 2026-02-14  
Цель: стабильная работа на ТВ с пульта (фокус/Enter/Back), предсказуемые фильтры и отсутствие "пропусков" фокуса.

## Статус 51.2.0 (hardening)
- [x] Закрыты критичные HTML-инъекции (Tracker, file.name, filter chosen, empty message).
- [x] Добавлены отсутствующие i18n ключи `torbox_age_seconds/minutes/hours/days`.
- [x] Ошибки API сохраняют `detail/message` для 4xx/5xx.
- [x] Регистрация manifest через `Manifest.plugins = manifest` (с fallback), добавлен context launch.
- [x] Добавлена опция `Prefer permanent link` для `requestdl` c fallback.
- [x] Добавлены предпочтения пользователя (cached-only default, quality/audio/codec priorities, exclude trackers).
- [x] Улучшен выбор файла (эвристика + ignore sample/trailer + запоминание выбора).
- [x] Добавлены debug-overlay и экспорт диагностического отчета.
- [x] Добавлены unit + e2e smoke тесты и запуск в CI.

## Контекст: как устроена навигация в Lampa (коротко)
- Навигация завязана на элементы с классом `.selector`.
- Фокус/Enter работают через события `hover:focus`, `hover:enter`, `hover:long`.
- `Lampa.Controller` переключает активный контроллер (`Controller.toggle(name)`), а `Controller.collectionSet(...)` формирует коллекцию для `Navigator`.
- `Navigator` (SpatialNavigator) двигает фокус по геометрии элементов; `Navigator.follow('focus', ...)` прокидывает фокус в `Controller.focus(...)`.
- `Lampa.Filter` (панель фильтров) по умолчанию содержит кнопки `.filter--search`, `.filter--sort`, `.filter--filter` (и опционально `.filter--back`), которые сами обрабатывают `hover:enter`.

## Результаты аудита (критичное)
- Проблема с фильтрами на ТВ часто упирается не в "логику фильтрации", а в то, что фокус уходит/не попадает на реальную кнопку фильтра. Если фокус встал на кастомный элемент вместо `.filter--filter`, пользователь нажимает OK и "фильтр не открывается".
- Динамически добавляемые элементы (например, панель «Продолжить просмотр») должны попадать в коллекцию навигации (`Navigator._collection`), иначе фокус на них может "не вставать" и возникают ощущения "пропуска".

## Этап 0. База и воспроизводимость
- [ ] Зафиксировать версию Lampa (сборка/платформа), где наблюдается баг: Tizen/WebOS/AndroidTV/Browser.
- [ ] Описать точный сценарий "фильтр не работает": откуда нажимаем, какая кнопка, что ожидаем.
- [ ] Включить debug-режим плагина и собрать логи консоли при проблеме.
- [ ] Сделать короткое видео/скринкаст поведения фокуса (если возможно) для сравнения "до/после".

## Этап 1. Фокус и навигация (TV/пульт) (P0)
### 1.1. Доступ к фильтрам с пульта
- [x] Привязать фокус фильтра к реальным кнопкам Lampa (`.filter--search/.filter--sort/.filter--filter`) + нашему `⚡/☁️`.
- [x] На `Right` из списка фокусировать именно `.filter--filter` (чтобы OK открывал список фильтров).
- [x] Открывать фильтр через `hover:enter` на `.filter--filter` (а не только через прямой `filter.show(...)`).
- [ ] Тест (TV): `Right` из любого элемента списка -> фокус на "Фильтр" -> OK -> открывается список фильтров.
- [ ] Тест (TV): `Right` -> `Left/Right` по панели фильтра -> OK на `⚡/☁️` переключает режим и не ломает фокус.

### 1.2. Устранение "пропусков" фокуса
- [x] Добавить панель «Продолжить просмотр» в навигационную коллекцию при создании (и удалять из коллекции при удалении).
- [x] Привести `Controller.collectionSet(...)` к правилам по режимам.
- [x] В режиме `torrents` коллекция навигации = фильтр + список.
- [x] В режиме `episodes` коллекция навигации = только список файлов (без скрытого фильтра).
- [ ] Тест (TV): после появления «Продолжить просмотр» переход `Up` с первого элемента списка корректно попадает в панель/фильтры без "скачков".
- [ ] Тест (TV): вход в эпизоды -> навигация вверх/вниз без прыжков в скрытые элементы фильтра.

### 1.3. Диагностика навигации (ускоряет поддержку)
- [ ] В debug-режиме логировать: активный контроллер, `focusState.zone/index`, CSS-селектор текущего элемента.
- [ ] Опционально: добавить маленький debug-overlay (только при debug=1), показывающий зону/индекс фокуса на экране.
- [ ] Тест (TV/Browser): включить debug -> убедиться, что логи/overlay не ломают UI.

## Этап 2. Фильтры/сортировка: корректность и устойчивость (P0/P1)
- [ ] Проверить, что `buildFilter()` всегда вызывается перед отображением списка (нет состояния "кнопка фильтра есть, но список пустой/неактивный").
- [ ] Проверить корректность сохранения/восстановления:
  - `torbox_filters_v2`
  - `torbox_sort_method`
  - `torbox_show_only_cached`
- [ ] Тест (TV): изменить фильтр/сортировку -> выйти назад -> снова открыть -> состояние восстановилось.
- [ ] Тест: при фильтрах, дающих 0 результатов, показывается пустое состояние и фильтр можно открыть/изменить.

## Этап 3. Эпизоды и отметка просмотренного (P1)
- [ ] Проверить навигацию в режиме эпизодов: фокус первый/последний элемент, Back возвращает на торренты.
- [ ] Проверить UX "last played": корректно выбирается последний файл и фокусится при открытии эпизодов.
- [ ] Тест (TV): выбрать файл -> отменить плеер -> убедиться, что UI откатился и не записал просмотренное.
- [ ] Тест (TV): досмотреть/закрыть -> отметка просмотренного появляется, список не ломается.

## Этап 4. Сеть, API, отмена запросов (P1)
- [ ] Проверить сценарии: proxy отсутствует / API key отсутствует / 401/403/429 / timeout.
- [ ] Проверить, что `AbortController` реально отменяет активные цепочки и не оставляет "висящий" Loading.
- [ ] Тест: быстро нажимать Back во время поиска/проверки кэша/трекинга -> приложение не зависает, экран восстанавливается.

## Этап 5. Производительность и память (P2)
- [ ] Замерить поведение на слабых ТВ: 100-300 элементов, плавность скролла, время перерендера.
- [ ] Проверить лимиты:
  - `MAX_DRAW_ITEMS`
  - `RAW_CACHE_HASH_LIMIT`
  - `MAX_WATCHED_EPISODES`
  - `MAX_SNAPSHOT_BYTES`
- [ ] Тест: большой список -> фильтры переключаются быстро, фокус не теряется.

## Этап 6. Релизный чеклист (каждый релиз)
- [ ] Прогнать ручной чек-лист (см. ниже) на TV-устройстве.
- [ ] Увеличить `VERSION`, обновить README changelog.
- [ ] В debug=1 собрать метрики/логи и приложить к релиз-нотам (для поддержки).

## Ручной чек-лист (TV) (обязателен)
- [ ] Открыть карточку фильма/сериала -> зайти в TorBox.
- [ ] Пока идет загрузка: `Right/Left/Up/Down/Back` не ломают экран.
- [ ] Список торрентов: `Up/Down` листает, фокус не пропадает.
- [ ] `Right` из списка -> фокус на "Фильтр" -> OK -> открывается список фильтров.
- [ ] В фильтрах: выбрать качество/язык/кодек -> список обновился -> фокус предсказуемый.
- [ ] Переключатель `⚡/☁️`: OK переключает режим, список обновляется, фокус не "скачет".
- [ ] «Продолжить просмотр» (если есть): можно сфокусировать и открыть, Back возвращает корректно.
- [ ] Торрент с несколькими файлами: вход в эпизоды -> навигация -> OK -> запуск -> Back -> возврат.
