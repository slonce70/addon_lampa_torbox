# TorBox Lampa Plugin

Плагин для [Lampa](https://lampa.mx), который добавляет просмотр торрентов через [TorBox.app](https://torbox.app) прямо из карточки фильма/сериала.

Текущая версия: **51.1.6**

## Установка
1. Откройте Lampa: `Настройки` → `Плагины` → `Добавить плагин`.
2. Вставьте URL:
   ```
   https://slonce70.github.io/addon_lampa_torbox/torbox-lampa-plugin.js
   ```
3. Нажмите `Enter`.

## Настройка
`Настройки` → `TorBox`:
- `API key`: ключ TorBox.
- `CORS proxy URL`: URL прокси (через него идут все запросы).
- `Debug mode`: включает подробные логи в консоль.

Дополнительно:
- `Tracking retries` (3–120) и `Tracking interval` (3000–60000 ms): опрос статуса торрента.
- `Video extensions`: список расширений для отбора файлов серий.

## Управление с пульта (TV)
- Навигация построена на стандартных правилах Lampa: элементы с `.selector` и события `hover:focus/hover:enter`.
- `Right` из списка торрентов переводит фокус на кнопку фильтра (`filter--filter`), чтобы `OK` открывал фильтры.
- Переключатель `⚡/☁️` встроен в панель фильтров и не должен ломать фокус.

## Тестирование
Автотесты в этом репозитории минимальные и проверяют корректность сборки/версий.

### Быстрые проверки (локально)
```bash
node scripts/validate.js
```

### Ручной чек-лист на TV
См. `plan.md` (раздел “Ручной чек-лист (TV)”).

## Диагностика
- Включи `Debug mode` и смотри `Console` (сообщения с префиксом `[TorBox]`).
- Если на ТВ “фильтр не открывается”, почти всегда причина в фокусе (не на той кнопке) или в том, что элемент не попал в коллекцию навигации.

## Changelog

### 51.1.6
- `Right` из списка торрентов теперь сразу открывает фильтры (без промежуточного наведения на кнопку).
- При наличии «Продолжить просмотр»: `Up` с первого элемента списка сначала переводит фокус на панель «Продолжить просмотр», а уже потом на поиск/фильтры (логический порядок сверху вниз).
- Отметка просмотренной серии стала надёжнее: серия помечается как просмотренная сразу после успешного старта плеера (даже если callback плеера в конкретной сборке не срабатывает).

### 51.1.5
- Исправлен сценарий с появлением «Продолжить просмотр»: фокус больше не “проскальзывает” мимо панели поиска/фильтров и не уводит навигацию наверх.
- Навигация стала стабильнее: по умолчанию фокус стартует со списка, `Up` ведёт в фильтры/поиск, `Down` из фильтров ведёт в «Продолжить просмотр» (если есть).

### 51.1.4
- Исправлена навигация по фильтрам на ТВ: фокус с пульта попадает на реальную кнопку `filter--filter`, а не на кастомный переключатель.
- Панель «Продолжить просмотр» добавляется/удаляется из навигационной коллекции, чтобы фокус не «пропускал» элемент.

### 51.1.3
- Исправлена навигация: первый переход вправо фокусирует панель фильтров, вверх с первого элемента списка переносит к фильтрам и поиску без дополнительных нажатий.
- Переключатель «⚡/☁️» интегрирован в панель фильтров и не перехватывает управление.

### 51.1.2
- Добавлена защита `try/catch` вокруг инициализации, запись стека ошибки в `localStorage` и нотификация в Lampa, обновление версии.

### 51.1.1
- Исправлен критический регресс, мешавший загрузке плагина (инициализация контроллеров фокуса вызывалась до определения функций).

### 51.1.0
- Введена табличная схема фокуса с учётом панели «Продолжить просмотр» и переключателя кеша.
- Добавлен безопасный откат UI при отменённом/несостающемся воспроизведении, отметка серий выполняется только после старта.
- Исключены «сырые» данные из кеша и состояния, списки просмотренных серий ограничены 250 записями, снапшоты урезаются по размеру.
- Появились настройки количества повторов трекинга, интервала опроса и списка видео-расширений; данные нормализуются автоматически.
- Генератор уточнений поиска учитывает альтернативные названия, годы, сезоны, ключевые слова и ID, подсказки снабжены метками категорий.
